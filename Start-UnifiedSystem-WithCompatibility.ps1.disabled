# Start-UnifiedSystem-WithCompatibility.ps1
# Unified system startup with Bootstrap Orchestrator compatibility layer
# Date: 2025-08-22
# Phase 3 Day 2: Migration and Backward Compatibility - Hour 3-4

param(
    [switch]$SkipCLIOrchestrator = $false,
    [switch]$UseLegacyMode = $false,        # NEW: Force legacy mode
    [switch]$UseManifestMode = $false,      # NEW: Force manifest-based mode
    [switch]$RunMigration = $false,         # NEW: Run migration before startup
    [switch]$Debug = $false
)

$ErrorActionPreference = "Continue"

# Change to script directory
$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
if ($scriptDir) {
    Set-Location $scriptDir
}

# Load compatibility layer
try {
    Import-Module ".\Migration\Legacy-Compatibility.psm1" -Force
    $compatibilityLoaded = $true
    Write-Host "Loaded backward compatibility layer" -ForegroundColor Cyan
} catch {
    Write-Warning "Could not load compatibility layer: $($_.Exception.Message)"
    Write-Warning "Falling back to legacy mode only"
    $compatibilityLoaded = $false
    $UseLegacyMode = $true
}

Write-Host "==================================================" -ForegroundColor Cyan
Write-Host "Unity-Claude Unified System Startup (WITH COMPATIBILITY)" -ForegroundColor Cyan
Write-Host "==================================================" -ForegroundColor Cyan
Write-Host "Starting at: $(Get-Date)" -ForegroundColor Cyan
Write-Host ""

# Show migration status and provide guidance
if ($compatibilityLoaded) {
    Write-Host "=== MIGRATION STATUS ===" -ForegroundColor Yellow
    $migrationStatus = Test-MigrationStatus
    Write-Host "Current Status: $($migrationStatus.Status)" -ForegroundColor White
    
    if ($migrationStatus.Details) {
        $migrationStatus.Details | ForEach-Object {
            Write-Host "  - $_" -ForegroundColor Gray
        }
    }
    
    if ($migrationStatus.RecommendedAction) {
        Write-Host "Recommended Action: $($migrationStatus.RecommendedAction)" -ForegroundColor Cyan
    }
    Write-Host ""
    
    # Offer to run migration if needed
    if ($migrationStatus.Status -eq "Pre-Migration" -and -not $RunMigration -and -not $UseLegacyMode) {
        Write-Host "MIGRATION AVAILABLE:" -ForegroundColor Green
        Write-Host "  You can upgrade to the new manifest-based system." -ForegroundColor White
        Write-Host "  This provides better dependency management and resource control." -ForegroundColor White
        Write-Host "" -ForegroundColor White
        Write-Host "Options:" -ForegroundColor Yellow
        Write-Host "  1. Run migration now: Add -RunMigration parameter" -ForegroundColor White
        Write-Host "  2. Use legacy mode: Add -UseLegacyMode parameter" -ForegroundColor White
        Write-Host "  3. Force manifest mode: Add -UseManifestMode parameter" -ForegroundColor White
        Write-Host ""
        
        if (-not $UseLegacyMode -and -not $UseManifestMode) {
            $choice = Read-Host "Run migration now? (Y/N) [Default: N]"
            if ($choice -eq "Y" -or $choice -eq "y") {
                $RunMigration = $true
            }
        }
    }
}

# Run migration if requested
if ($RunMigration) {
    Write-Host "=== RUNNING MIGRATION ===" -ForegroundColor Green
    
    $migrationScript = ".\Migration\Migrate-ToManifestSystem.ps1"
    if (Test-Path $migrationScript) {
        Write-Host "Executing migration script..." -ForegroundColor Cyan
        
        try {
            $migrationResult = & $migrationScript -Verbose
            
            if ($migrationResult.Success) {
                Write-Host "Migration completed successfully!" -ForegroundColor Green
                Write-Host "Migration Report: $($migrationResult.ReportPath)" -ForegroundColor Cyan
                Write-Host ""
                
                # Update mode selection based on migration results
                if (-not $UseLegacyMode) {
                    $UseManifestMode = $true
                    Write-Host "Switching to manifest-based mode for startup" -ForegroundColor Green
                }
            } else {
                Write-Warning "Migration completed with issues"
                Write-Host "Check migration log: $($migrationResult.LogPath)" -ForegroundColor Yellow
                
                # Ask user what to do
                $choice = Read-Host "Continue with legacy mode? (Y/N) [Default: Y]"
                if ($choice -ne "N" -and $choice -ne "n") {
                    $UseLegacyMode = $true
                } else {
                    Write-Host "Aborting startup" -ForegroundColor Red
                    exit 1
                }
            }
        } catch {
            Write-Error "Migration failed: $($_.Exception.Message)"
            $choice = Read-Host "Continue with legacy mode? (Y/N) [Default: Y]"
            if ($choice -ne "N" -and $choice -ne "n") {
                $UseLegacyMode = $true
            } else {
                Write-Host "Aborting startup" -ForegroundColor Red
                exit 1
            }
        }
    } else {
        Write-Warning "Migration script not found: $migrationScript"
        $UseLegacyMode = $true
    }
    
    Write-Host ""
}

# Determine startup mode
Write-Host "=== STARTUP MODE SELECTION ===" -ForegroundColor Yellow

if ($UseLegacyMode -and $UseManifestMode) {
    Write-Error "Cannot specify both -UseLegacyMode and -UseManifestMode"
    exit 1
}

$useManifestSystem = $false

if ($UseLegacyMode) {
    Write-Host "Mode: Legacy (forced by parameter)" -ForegroundColor Yellow
    $useManifestSystem = $false
} elseif ($UseManifestMode) {
    Write-Host "Mode: Manifest-based (forced by parameter)" -ForegroundColor Green
    $useManifestSystem = $true
} else {
    # Auto-detect best mode
    if ($compatibilityLoaded) {
        $migrationStatus = Test-MigrationStatus
        
        if ($migrationStatus.ManifestsExist) {
            Write-Host "Mode: Manifest-based (auto-detected)" -ForegroundColor Green
            $useManifestSystem = $true
        } else {
            Write-Host "Mode: Legacy (auto-detected - no manifests found)" -ForegroundColor Yellow
            $useManifestSystem = $false
        }
    } else {
        Write-Host "Mode: Legacy (compatibility layer failed to load)" -ForegroundColor Yellow
        $useManifestSystem = $false
    }
}

Write-Host ""

# Execute startup using selected system
if ($useManifestSystem -and $compatibilityLoaded) {
    Write-Host "=== MANIFEST-BASED SYSTEM STARTUP ===" -ForegroundColor Green
    
    try {
        $result = Start-UnityClaudeSystem -UseManifestMode -Debug:$Debug
        
        if ($result.Success) {
            Write-Host "Manifest-based system startup completed successfully!" -ForegroundColor Green
            Write-Host "Started subsystems: $($result.StartedSubsystems -join ', ')" -ForegroundColor Cyan
            Write-Host "Total subsystems: $($result.TotalSubsystems)" -ForegroundColor Cyan
        } else {
            Write-Warning "Manifest-based startup failed: $($result.Message)"
            Write-Host "Falling back to legacy mode..." -ForegroundColor Yellow
            $useManifestSystem = $false
        }
    } catch {
        Write-Error "Manifest-based startup error: $($_.Exception.Message)"
        Write-Host "Falling back to legacy mode..." -ForegroundColor Yellow
        $useManifestSystem = $false
    }
}

if (-not $useManifestSystem) {
    Write-Host "=== LEGACY SYSTEM STARTUP ===" -ForegroundColor Yellow
    
    # Show deprecation warning for legacy mode
    if ($compatibilityLoaded) {
        Show-DeprecationWarning -FunctionName "Legacy System Startup" -Replacement "Manifest-based Bootstrap Orchestrator"
    }
    
    # Original legacy startup logic (simplified)
    try {
        Write-Host "Step 1: Finding Claude Code CLI..." -ForegroundColor Yellow
        
        $claudePID = $null
        try {
            if (Test-Path ".\Get-ClaudeCodePID.ps1") {
                $claudePID = & ".\Get-ClaudeCodePID.ps1"
                if ($claudePID) {
                    Write-Host "  Claude Code CLI found: PID $claudePID" -ForegroundColor Green
                } else {
                    Write-Host "  Claude Code CLI not found (will continue anyway)" -ForegroundColor Yellow
                }
            }
        } catch {
            Write-Host "  Error finding Claude Code CLI: $($_.Exception.Message)" -ForegroundColor Yellow
        }
        
        Write-Host ""
        Write-Host "Step 2: Starting SystemStatus monitoring..." -ForegroundColor Yellow
        
        # Option to sign scripts first
        $signScripts = Read-Host "Sign all scripts to avoid execution policy issues? (Y/N) [Default: N]"
        if ($signScripts -eq "Y") {
            Write-Host "  Signing all PowerShell scripts..." -ForegroundColor Cyan
            if (Test-Path ".\Sign-PowerShellScripts.ps1") {
                & .\Sign-PowerShellScripts.ps1
                Write-Host "  Scripts signed successfully" -ForegroundColor Green
            }
        }
        
        # Use compatibility-enhanced monitoring script if available
        $monitoringScript = ".\Start-SystemStatusMonitoring-Enhanced-WithCompatibility.ps1"
        if (-not (Test-Path $monitoringScript)) {
            $monitoringScript = ".\Start-SystemStatusMonitoring-Enhanced.ps1"
        }
        
        if (Test-Path $monitoringScript) {
            Write-Host "  Starting monitoring using: $monitoringScript" -ForegroundColor Cyan
            
            $monitoringJob = Start-Job -Name "SystemStatusMonitoring" -ScriptBlock {
                param($ScriptPath, $UseLegacy)
                if ($UseLegacy) {
                    & $ScriptPath -UseLegacyMode -EnableHeartbeat -EnableFileWatcher
                } else {
                    & $ScriptPath -EnableHeartbeat -EnableFileWatcher
                }
            } -ArgumentList $monitoringScript, $UseLegacyMode
            
            if ($monitoringJob) {
                Write-Host "  SystemStatus monitoring started (Job ID: $($monitoringJob.Id))" -ForegroundColor Green
            }
        } else {
            Write-Warning "SystemStatus monitoring script not found"
        }
        
        # Start AutonomousAgent if not skipped
        if (-not $SkipCLIOrchestrator) {
            Write-Host ""
            Write-Host "Step 3: Starting CLI Orchestrator..." -ForegroundColor Yellow
            
            # Wait for SystemStatus to initialize
            Start-Sleep -Seconds 3
            
            $agentScript = ".\Start-CLIOrchestrator-Fixed.ps1"
            if (Test-Path $agentScript) {
                $agentJob = Start-Job -Name "CLIOrchestrator" -ScriptBlock {
                    param($ScriptPath)
                    & $ScriptPath
                } -ArgumentList $agentScript
                
                if ($agentJob) {
                    Write-Host "  AutonomousAgent started (Job ID: $($agentJob.Id))" -ForegroundColor Green
                }
            } else {
                Write-Warning "AutonomousAgent script not found: $agentScript"
            }
        } else {
            Write-Host ""
            Write-Host "Step 3: Skipping CLI Orchestrator (as requested)" -ForegroundColor Yellow
        }
        
        # Display final status
        Write-Host ""
        Write-Host "=== LEGACY STARTUP COMPLETE ===" -ForegroundColor Green
        
        $jobs = Get-Job | Where-Object { $_.Name -match "SystemStatus|CLIOrchestrator" }
        if ($jobs) {
            Write-Host "Active subsystem jobs:" -ForegroundColor Cyan
            $jobs | ForEach-Object {
                $status = switch ($_.State) {
                    "Running" { "[RUNNING]" }
                    "Completed" { "[COMPLETED]" }
                    "Failed" { "[FAILED]" }
                    default { "[$($_.State)]" }
                }
                Write-Host "  - $($_.Name): $status" -ForegroundColor White
            }
        }
        
    } catch {
        Write-Error "Legacy startup failed: $($_.Exception.Message)"
        exit 1
    }
}

# Final status and recommendations
Write-Host ""
Write-Host "=== SYSTEM STARTUP COMPLETE ===" -ForegroundColor Green
Write-Host "Mode Used: $(if ($useManifestSystem) { 'Manifest-based Bootstrap Orchestrator' } else { 'Legacy Hardcoded Configuration' })" -ForegroundColor Cyan
Write-Host "Startup Time: $(Get-Date)" -ForegroundColor Cyan

if (-not $useManifestSystem -and $compatibilityLoaded) {
    Write-Host ""
    Write-Host "FUTURE UPGRADE AVAILABLE:" -ForegroundColor Yellow
    Write-Host "Consider upgrading to manifest-based system for:" -ForegroundColor White
    Write-Host "  - Better dependency management" -ForegroundColor White
    Write-Host "  - Resource limit enforcement" -ForegroundColor White
    Write-Host "  - Improved error recovery" -ForegroundColor White
    Write-Host "  - Centralized configuration" -ForegroundColor White
    Write-Host ""
    Write-Host "To upgrade: .\Migration\Migrate-ToManifestSystem.ps1" -ForegroundColor Cyan
}

Write-Host ""
Write-Host "System is now running. Press Ctrl+C to stop or close this window." -ForegroundColor Gray

# Keep script running to monitor jobs
try {
    while ($true) {
        Start-Sleep -Seconds 30
        
        # Check job health in legacy mode
        if (-not $useManifestSystem) {
            $jobs = Get-Job | Where-Object { $_.Name -match "SystemStatus|CLIOrchestrator" }
            $failedJobs = $jobs | Where-Object { $_.State -eq "Failed" }
            
            if ($failedJobs) {
                Write-Host "[$(Get-Date)] WARNING: Failed jobs detected:" -ForegroundColor Red
                $failedJobs | ForEach-Object {
                    Write-Host "  - $($_.Name): $($_.State)" -ForegroundColor Red
                }
            }
        }
    }
} catch {
    Write-Host "System monitoring stopped: $($_.Exception.Message)" -ForegroundColor Yellow
}
# SIG # Begin signature block
# MIIFzgYJKoZIhvcNAQcCoIIFvzCCBbsCAQExDzANBglghkgBZQMEAgEFADB5Bgor
# BgEEAYI3AgEEoGswaTA0BgorBgEEAYI3AgEeMCYCAwEAAAQQH8w7YFlLCE63JNLG
# KX7zUQIBAAIBAAIBAAIBAAIBADAxMA0GCWCGSAFlAwQCAQUABCB8oRdcZTrIrejP
# WPYxKiklHJ74xQGfhmYnyf9G0ZABTKCCAzAwggMsMIICFKADAgECAhB1HRbZIqgr
# lUTwkh3hnGtFMA0GCSqGSIb3DQEBCwUAMC4xLDAqBgNVBAMMI1VuaXR5LUNsYXVk
# ZS1BdXRvbWF0aW9uLURldmVsb3BtZW50MB4XDTI1MDgyMDIxMTUxN1oXDTI2MDgy
# MDIxMzUxN1owLjEsMCoGA1UEAwwjVW5pdHktQ2xhdWRlLUF1dG9tYXRpb24tRGV2
# ZWxvcG1lbnQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCx4feqKdUQ
# 6GufY4umNzlM1Pi8aHUGR8HlfhIWFjsrRAxCxhieRlWbHe0Hw+pVBeX76X57e5Pu
# 4Kxxzu+MxMry0NJYf3yOLRTfhYskHBcLraXUCtrMwqnhPKvul6Sx6Lu8vilk605W
# ADJNifl3WFuexVCYJJM9G2mfuYIDN+rZ5zmpn0qCXum49bm629h+HyJ205Zrn9aB
# hIrA4i/JlrAh1kosWnCo62psl7ixbNVqFqwWEt+gAqSeIo4ChwkOQl7GHmk78Q5I
# oRneY4JTVlKzhdZEYhJGFXeoZml/5jcmUcox4UNYrKdokE7z8ZTmyowBOUNS+sHI
# G1TY5DZSb8vdAgMBAAGjRjBEMA4GA1UdDwEB/wQEAwIHgDATBgNVHSUEDDAKBggr
# BgEFBQcDAzAdBgNVHQ4EFgQUfDms7LrGVboHjmwlSyIjYD/JLQwwDQYJKoZIhvcN
# AQELBQADggEBABRMsfT7DzKy+aFi4HDg0MpxmbjQxOH1lzUzanaECRiyA0sn7+sA
# /4jvis1+qC5NjDGkLKOTCuDzIXnBWLCCBugukXbIO7g392ANqKdHjBHw1WlLvMVk
# 4WSmY096lzpvDd3jJApr/Alcp4KmRGNLnQ3vv+F9Uj58Uo1qjs85vt6fl9xe5lo3
# rFahNHL4ngjgyF8emNm7FItJeNtVe08PhFn0caOX0FTzXrZxGGO6Ov8tzf91j/qK
# QdBifG7Fx3FF7DifNqoBBo55a7q0anz30k8p+V0zllrLkgGXfOzXmA1L37Qmt3QB
# FCdJVigjQMuHcrJsWd8rg857Og0un91tfZIxggH0MIIB8AIBATBCMC4xLDAqBgNV
# BAMMI1VuaXR5LUNsYXVkZS1BdXRvbWF0aW9uLURldmVsb3BtZW50AhB1HRbZIqgr
# lUTwkh3hnGtFMA0GCWCGSAFlAwQCAQUAoIGEMBgGCisGAQQBgjcCAQwxCjAIoAKA
# AKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQwHAYKKwYBBAGCNwIBCzEO
# MAwGCisGAQQBgjcCARUwLwYJKoZIhvcNAQkEMSIEIIKZD8G4mdARLlKN3Fbl0nyl
# DUVlDpM2hlKjpwEyX1eiMA0GCSqGSIb3DQEBAQUABIIBACPTU5o2ifH2zOPXooiT
# QkwPKQP4PAbRmUD+O+SuRjXFDCsQcyi/5syXHyYS3Saj1REqp8L5UOralNuKXut0
# F2AOI+TIMAjfilKCSyuwDmc9Ybw6WnLTSPmVuWEYSOQoizO2ghVyz803trLR87Yl
# noyJIG/a7WpweURlCsJ8CyxvVyY+DNBHzRkEZ9Qals+mA62GPwv3c047vmh3FrbW
# pIjmXQgWz4ivuwfiaOAX3SgkFrjIS3zmfgzODEE7k5NPUseP2zpp2MmaBiIl0mrA
# zMh5VreWiQK9t2EaevlSzX3lft4iRUtJybtowU+SNH5NLiNvtdoBmJ+bLFSdf2RW
# 4fE=
# SIG # End signature block
