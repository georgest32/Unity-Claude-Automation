# Enhanced Documentation System - AI Services Docker Compose
# Fixed LangGraph and AutoGen services with proper build contexts
# Date: 2025-08-29

networks:
  unity-claude-net:
    driver: bridge

volumes:
  langgraph-data:
    driver: local
  shared-config:
    driver: local

services:
  # LangGraph API Service - FIXED
  langgraph-api:
    build:
      context: .  # Use root directory as build context
      dockerfile: docker/python/langgraph/Dockerfile
    container_name: unity-claude-langgraph
    networks:
      - unity-claude-net
    volumes:
      - langgraph-data:/app/data
      - shared-config:/app/config:ro
      - ./agents:/app/agents:ro
    environment:
      - LANGGRAPH_DB_PATH=/app/data/langgraph.db
      - PYTHONUNBUFFERED=1
      # Research-validated binding for AI service
      - HOST=0.0.0.0
      - PORT=8000
      - BIND_HOST=0.0.0.0
    ports:
      - "8000:8000"
    restart: unless-stopped
    # Enhanced health check for LangGraph
    healthcheck:
      test: ["CMD", "curl", "-f", "http://0.0.0.0:8000/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s  # Extended for AI service initialization
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "3"

  # AutoGen GroupChat Service - FIXED  
  autogen-groupchat:
    build:
      context: .  # Use root directory as build context
      dockerfile: docker/python/autogen/Dockerfile
    container_name: unity-claude-autogen
    networks:
      - unity-claude-net
    volumes:
      - shared-config:/app/config:ro
      - ./agents:/app/agents:ro
    environment:
      - PYTHONUNBUFFERED=1
      - AUTOGEN_USE_DOCKER=0
      # Research-validated binding for AutoGen
      - HOST=0.0.0.0
      - PORT=8001
      - AUTOGEN_HOST=0.0.0.0
    ports:
      - "8001:8001"
    depends_on:
      langgraph-api:
        condition: service_healthy
    restart: unless-stopped
    # Enhanced health check for AutoGen
    healthcheck:
      test: ["CMD", "curl", "-f", "http://0.0.0.0:8001/health"]
      interval: 45s
      timeout: 20s
      retries: 3
      start_period: 240s  # Extended for AutoGen AI model initialization
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "3"

  # Simple PowerShell service for AI integration
  powershell-ai:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    container_name: unity-claude-powershell-ai
    networks:
      - unity-claude-net
    volumes:
      - ./Modules:/opt/modules:ro
      - ./agents:/opt/agents:ro
      - shared-config:/app/config
    environment:
      - POWERSHELL_TELEMETRY_OPTOUT=1
      - PSModulePath=/opt/modules
      - HOST=0.0.0.0
    working_dir: /opt/modules
    command: >
      pwsh -c "
      Write-Host 'ü§ñ Enhanced Documentation System - AI Integration Service';
      Write-Host 'Loading predictive analysis modules...';
      try {
        Import-Module '/opt/modules/Unity-Claude-CPG/Core/Predictive-Evolution.psm1' -Force;
        Import-Module '/opt/modules/Unity-Claude-CPG/Core/Predictive-Maintenance.psm1' -Force;
        Write-Host '‚úÖ Week 4 Predictive Analysis modules loaded successfully';
      } catch {
        Write-Host '‚ö†Ô∏è Week 4 modules loading failed: ' + $_.Exception.Message;
      }
      Write-Host 'AI Integration Service ready - monitoring for requests...';
      while ($true) { 
        Start-Sleep 30; 
        Write-Host 'AI Integration Service active - $(Get-Date) - Week 4 features available'
      }
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pwsh", "-Command", "Write-Output 'ai-service-healthy'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"