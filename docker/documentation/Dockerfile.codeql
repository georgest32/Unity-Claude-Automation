# Enhanced Documentation System - CodeQL Security Analysis Service
# Phase 3 Day 5: Production Integration & Advanced Features
# Integrates with existing Unity-Claude Docker infrastructure

FROM ubuntu:22.04 AS build-stage

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    unzip \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install CodeQL CLI
RUN wget -q "https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql-linux64.zip" -O /tmp/codeql.zip && \
    unzip /tmp/codeql.zip -d /opt/ && \
    chmod +x /opt/codeql/codeql && \
    rm /tmp/codeql.zip

# Production stage
FROM ubuntu:22.04 AS production

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    jq \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Copy CodeQL from build stage
COPY --from=build-stage /opt/codeql /opt/codeql

# Create symlink for CodeQL CLI
RUN ln -s /opt/codeql/codeql /usr/local/bin/codeql

# Create application directories
RUN mkdir -p /app /codeql/databases /codeql/queries /docs/generated/security

# Create non-root user
RUN groupadd -r codeql && useradd -r -g codeql codeql && \
    chown -R codeql:codeql /app /codeql /docs && \
    chmod -R 755 /app /codeql /docs

# Copy custom CodeQL queries
COPY docker/documentation/codeql-queries/ /codeql/queries/

# Copy CodeQL analysis script
COPY docker/documentation/run-codeql-analysis.py /app/
RUN chmod +x /app/run-codeql-analysis.py

# Create health check script
RUN echo '#!/bin/bash' > /app/health-check.sh && \
    echo 'if [ -f /codeql/databases/health.txt ]; then' >> /app/health-check.sh && \
    echo '  exit 0' >> /app/health-check.sh && \
    echo 'else' >> /app/health-check.sh && \
    echo '  echo "Creating health status..."' >> /app/health-check.sh && \
    echo '  echo "$(date): CodeQL service operational" > /codeql/databases/health.txt' >> /app/health-check.sh && \
    echo '  exit 0' >> /app/health-check.sh && \
    echo 'fi' >> /app/health-check.sh && \
    chmod +x /app/health-check.sh

# Switch to non-root user
USER codeql

# Set working directory
WORKDIR /app

# Environment variables
ENV CODEQL_HOME=/opt/codeql \
    CODEQL_DB_PATH=/codeql/databases \
    RESULTS_PATH=/docs/generated/security \
    SCAN_INTERVAL=3600

# Health check
HEALTHCHECK --interval=120s --timeout=60s --start-period=300s --retries=2 \
    CMD /app/health-check.sh

# Entry point
CMD ["python3", "/app/run-codeql-analysis.py"]