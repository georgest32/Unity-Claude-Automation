# Fluent Bit Configuration
# Unity-Claude Automation Log Collection
# Version: 2025-08-24

[SERVICE]
    Flush             5
    Daemon            Off
    Log_Level         info
    Parsers_File      parsers.conf
    Plugins_File      plugins.conf
    HTTP_Server       On
    HTTP_Listen       0.0.0.0
    HTTP_Port         2020
    Health_Check      On
    HC_Errors_Count   5
    HC_Retry_Failure_Count 5
    HC_Period         60
    Storage.path      /var/log/flb-storage/
    Storage.sync      normal
    Storage.checksum  off
    Storage.max_chunks_pause  10
    Storage.backlog.mem_limit 5M

# Docker container logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /var/log/flb_docker.db
    DB.Sync           Normal

# System logs (if available)
[INPUT]
    Name              systemd
    Tag               systemd.*
    Read_From_Tail    On
    Strip_Underscores On

# PowerShell logs (Windows containers)
[INPUT]
    Name              tail
    Path              /var/log/powershell/*.log
    Parser            powershell
    Tag               powershell.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# Application logs
[INPUT]
    Name              tail
    Path              /var/log/apps/*.log
    Parser            json
    Tag               app.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# Filter to parse Docker logs
[FILTER]
    Name              parser
    Match             docker.*
    Key_Name          log
    Parser            json
    Reserve_Data      On
    Preserve_Key      On

# Filter to add metadata
[FILTER]
    Name              record_modifier
    Match             *
    Record            hostname ${HOSTNAME}
    Record            environment production
    Record            cluster unity-claude

# Filter to parse JSON logs
[FILTER]
    Name              parser
    Match             app.*
    Key_Name          log
    Parser            json
    Reserve_Data      On

# Filter for PowerShell specific processing
[FILTER]
    Name              parser
    Match             powershell.*
    Key_Name          log
    Parser            powershell
    Reserve_Data      On

# Filter to add container metadata from Docker labels
[FILTER]
    Name              grep
    Match             docker.*
    Regex             log ^(?!\s*$).+

# Filter to extract container name from Docker logs
[FILTER]
    Name              parser
    Match             docker.*
    Key_Name          stream
    Parser            container_name
    Reserve_Data      On

# Output to Loki
[OUTPUT]
    Name              loki
    Match             *
    Host              loki
    Port              3100
    Labels            job=fluent-bit,environment=production
    Label_Keys        container_name,container_id,hostname
    Remove_Keys       stream,time
    Line_Format       json
    Auto_Kubernetes_Labels off
    Retry_Limit       5

# Output to stdout for debugging (optional)
[OUTPUT]
    Name              stdout
    Match             *.error
    Format            json_lines

# Output metrics to Prometheus (optional)
[OUTPUT]
    Name              prometheus_exporter
    Match             metrics.*
    Host              0.0.0.0
    Port              2021
    Add_label         app unity-claude