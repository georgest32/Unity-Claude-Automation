# Fluent Bit Parsers Configuration
# Unity-Claude Automation
# Version: 2025-08-24

# Docker log parser
[PARSER]
    Name        docker
    Format      json
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%LZ
    Time_Keep   On
    Decode_Field_As escaped_utf8 log do_next
    Decode_Field_As json log

# JSON parser
[PARSER]
    Name        json
    Format      json
    Time_Key    timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%LZ
    Time_Keep   On

# PowerShell log parser
[PARSER]
    Name        powershell
    Format      regex
    Regex       ^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<message>.*)$
    Time_Key    timestamp
    Time_Format %Y-%m-%d %H:%M:%S
    Time_Keep   On

# Python log parser
[PARSER]
    Name        python
    Format      regex
    Regex       ^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (?<logger>\S+) - (?<level>\w+) - (?<message>.*)$
    Time_Key    timestamp
    Time_Format %Y-%m-%d %H:%M:%S,%L
    Time_Keep   On

# Nginx access log parser
[PARSER]
    Name        nginx_access
    Format      regex
    Regex       ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z

# Apache access log parser
[PARSER]
    Name        apache
    Format      regex
    Regex       ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z

# Syslog parser
[PARSER]
    Name        syslog
    Format      regex
    Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
    Time_Key    time
    Time_Format %b %d %H:%M:%S
    Time_Keep   On

# Container name parser from Docker log paths
[PARSER]
    Name        container_name
    Format      regex
    Regex       /var/lib/docker/containers/(?<container_id>[^/]+)/(?<container_name>[^/]+)-json\.log$

# Kubernetes pod parser
[PARSER]
    Name        kube-custom
    Format      regex
    Regex       (?<pod_name>[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*)_(?<namespace>[^_]+)_(?<container_name>.+)-(?<container_id>[a-z0-9]{64})\.log$

# Multi-line parser for stack traces
[MULTILINE_PARSER]
    Name        multiline-python
    Type        regex
    Flush_timeout 1000
    Rule        "start_state" "/^Traceback/" "python_traceback"
    Rule        "python_traceback" "/^[^\s]/" "start_state"

[MULTILINE_PARSER]
    Name        multiline-java
    Type        regex
    Flush_timeout 1000
    Rule        "start_state" "/^[^\s]/" "java_start"
    Rule        "java_start" "/^\s+at\s/" "java_traceback"
    Rule        "java_traceback" "/^\s+at\s/" "java_traceback"
    Rule        "java_traceback" "/^[^\s]/" "java_start"

[MULTILINE_PARSER]
    Name        multiline-dotnet
    Type        regex
    Flush_timeout 1000
    Rule        "start_state" "/^[^\s]/" "dotnet_start"
    Rule        "dotnet_start" "/^\s+at\s/" "dotnet_traceback"
    Rule        "dotnet_traceback" "/^\s+at\s/" "dotnet_traceback"
    Rule        "dotnet_traceback" "/^[^\s]/" "dotnet_start"